@page "/bookings"

@inject IJSRuntime js
@inject NavigationManager manager
@inject SingletonServise servise

<section> 
    <div class="modal fade" id="modalRegisterForm" data-bs-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Бронирование номера</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="ClaerBookingForm">
                    </button>
                </div>

                <EditForm Model="@bookModel" class="formRegistr" OnValidSubmit="@Submit">
                    <DataAnnotationsValidator />
                    <div class="modal-body mx-3">
                    <div class="md-form mb-5">
                        <iconify-icon icon="material-symbols:person"></iconify-icon>
                        <div id="inputBox" class="inputBoxClients">
                                <input class="fas fa-envelope prefix grey-text" type="text" @bind="nameClient" @bind:event="oninput" @onfocus="OpenClientList" @onkeyup="SearchingClientForSelect" required="required">
                            <span id="span">Клиент</span>
                                <div class="dropdownClients" style="display:@clientsSearch;">
                                @foreach (var client in sortingClients)
                                {
                                    <a @onclick="() => SelectCleint(client)">@client.ClientName</a>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="md-form mb-5">
                        <iconify-icon icon="pepicons-pop:persons"></iconify-icon>
                        <div id="inputBox">
                                <InputNumber @bind-Value="bookModel.AdaltCount" class="fas fa-envelope prefix grey-text" required="required" @onfocusout="GetRoomForPeopleCount" />
                            <span id="span">Кол-во взрослых</span>
                        </div>
                    </div>
                    <div class="md-form mb-5">
                        <iconify-icon icon="pepicons-pop:persons" ></iconify-icon>
                        <div id="inputBox">
                                <InputNumber @bind-Value="bookModel.ChildCount" class="fas fa-envelope prefix grey-text" @onfocusout="GetRoomForPeopleCount" required="required" />
                            <span id="span">Кол-во детей</span>
                        </div>
                    </div>
                        <div class="md-form mb-5">
                        <iconify-icon icon="icon-park-twotone:hotel-please-clean" style="top: 7px;"></iconify-icon>
                            <div class="typeList" >
                            <InputSelect @bind-Value="roomType" @onclick="GetRoomWithSelectType" required="required"
                                class="dropdown" style="outline:none; outline-style:none">
                                <option selected disabled></option>
                                <option value="Стандарт">Стандарт</option>
                                <option value="Бизнес">Бизнес</option>
                                <option value="Люкс одноместный">Люкс одноместный</option>
                                <option value="Люкс однокомнатный">Люкс двухкомнатный</option>
                                <option value="Люкс премиум">Люкс премиум</option>
                                </InputSelect>
                                <span id="span">Тип номера</span>
                            </div>
                        </div>
                    <div class="md-form mb-5">
                        <iconify-icon icon="ic:baseline-calendar-month"></iconify-icon>
                        <div id="inputBox">
                                <input name="date" id="from" @bind="chekInDate" @onfocusout="GetRoomWithoutBooking" type="text" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
                            <span id="span">Дата заезда</span>
                        </div>
                    </div>
                    <div class="md-form mb-5">
                        <iconify-icon icon="ic:baseline-calendar-month"></iconify-icon>
                        <div id="inputBox">
                            <input name="date" id="to" @bind="chekOutDate" type="text" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
                            <span id="span">Дата выезда</span>
                        </div>
                    </div>
                    <div class="md-form mb-5">
                        <iconify-icon icon="tabler:number" style="top:9px"></iconify-icon>
                            <div class="typeList" >
                            <InputSelect @bind-Value="roomNumber" required="required"
                                class="dropdown" style="outline:none; outline-style:none">
                                <option selected disabled></option>
                                    @if(sortingRooms != null)
                                    {
                                        @foreach (var room in sortingRooms)
                                        {
                                            <option value="@room.Number">@room.Number</option>
                                        }
                                    }
                                </InputSelect>
                                <span id="span">Номер</span>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-default btn-success" type="submit" data-bs-dismiss="modal" @onclick="Submit">Добавить</button>
                    </div>
                    </EditForm>
            </div>
        </div>
        </div>
    <div class="appbar" style="margin: 20px 0 0 10%">
        <input id="searching" class="sort" type="text" @bind="search" @bind:event="oninput" @onkeyup="SearchingForBook" required="required" placeholder="Поиск">
        <i id="searching" class="fas fa-search prefix grey-text"></i>
        <button id="newBook"  class="btn btn-default btn-success" @onclick=" () => NewBooking()" data-bs-toggle="modal" data-bs-target="#modalRegisterForm">
            Забронировать
        </button>
    </div>
    <table class="table" style="width: 80%; margin: 40px 10%;">
        <thead>
            <tr>
                <th>Номер комнаты</th>
                <th>Клиент</th>
                <th>Дата заезда</th>
                <th>Дата выезда</th>
                <th>Сумма проживания, р</th>
                <th>Изменить</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var book in sortingBookings)
            {
                <tr>
                    <td>@book.Room.Number</td>
                    <td>@book.Client.ClientName</td>
                    <td>@book.ArrivalDate</td>
                    <td>@book.DepartureDate</td>
                    <td>@book.TotalPrice</td>
                    <td>
                        <button class="button" style="vertical-align:middle" @onclick="() => OpenCurrentBooking(book)"><span>Изменить </span></button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</section>

@code {
    List<Booking> bookings = new List<Booking>();
    List<Booking> sortingBookings = new List<Booking>();
    List<Room> rooms = new List<Room>();
    List<Room> sortingRooms = new List<Room>();
    List<Client> clients = new List<Client>();
    List<Client> sortingClients = new List<Client>();
    Booking bookModel = new Booking();
    string clientsSearch = "none";
    string search = "";
    string nameClient = "";
    string chekInDate = "";
    string chekOutDate = "";
    Client client;
    string roomNumber;
    string roomType = "";
    bool wasSubmitted;


    protected override void OnInitialized()
    {
        js.InvokeVoidAsync("ChangePanelsState");
        bookings = Mongo.FindAllBooking();
        sortingBookings = bookings;
        clients = Mongo.FindAllClient();
        sortingClients = clients;
        rooms = Mongo.GetAllRooms();
        sortingRooms = rooms;
    }

    private void JsInvoce()
    {
        js.InvokeVoidAsync("date");
    }

    public void Submit()
    {
        wasSubmitted = true;
        AddNewBook();
    }

    private void NewBooking()
    {
        //servise.booking = newBooking;
        //manager.NavigateTo("booking");
    }

    private void AddNewBook()
    {
        var room = Mongo.GetRoom(int.Parse(roomNumber));
        var arrivalDate = GetDate(chekInDate);
        var departureDate = GetDate(chekOutDate);
        var price = Convert.ToDouble(room.Cost) * int.Parse(((arrivalDate.Day - departureDate.Day)).ToString());
        var newBook = new Booking(room, client, (int)bookModel.AdaltCount, (int)bookModel.ChildCount, arrivalDate, departureDate, price);
        Mongo.AddBookingToDB(newBook);
        bookings.Add(newBook);
        SearchingForBook();
    }

    private DateOnly GetDate(string date)
    {
        int year = int.Parse(date.Split('-')[0]);
        int mounth = int.Parse(date.Split('-')[1]);
        int day = int.Parse(date.Split('-')[2]);
        return new DateOnly(year, mounth, day);
    }

    private void OpenCurrentBooking(Booking booking)
    {
        servise.booking = booking;
        manager.NavigateTo("booking");
    }

    private void SortingRooms()
    {

    }

    private void GetRoomWithSelectType()
    {
        sortingRooms = rooms.Where((element) =>
            element.Type.ToLower().Contains(roomType.ToLower()))
        .ToList();
    }

    private void GetRoomWithoutBooking()
    {
        List<Room> list = new();
        foreach (var room in sortingRooms)
        {
            if (bookings.Find((book) => book.Room == room && book.DepartureDate <= GetDate(chekInDate)) != null) continue;
            else list.Add(room);

        }

        //bookings.Where((element) =>
        //    element.DepartureDate >= GetDate(chekInDate) || )
        //.ToList();

        //for(int i = 0; i < list.Count; i++)
        //{
        //    if(sortingRooms[i] == list[i].Room)
        //    {
        //        if (list[i].DepartureDate < GetDate(chekInDate))
        //        {
        //            newList.Add(sortingRooms[i]);
        //        }
        //    }
        //}
        sortingRooms = list;
    }

    private void GetRoomForPeopleCount()
    {
        sortingRooms = rooms.Where((element) =>
            element.Capacity >= bookModel.AdaltCount + bookModel.ChildCount)
        .ToList();
    }

    private void SearchingClientForSelect()
    {
        sortingClients = clients.Where((element) =>
            element.ClientName.ToLower().Contains(nameClient.ToLower()))
        .ToList();
    }



    private void SearchingForBook()
    {
        sortingBookings = bookings.Where((element) =>
            element.Client.ClientName.ToLower().Contains(search.ToLower()))
        .ToList();
    }

    private void OpenClientList()
    {
        clientsSearch = "block";
    }

    private void SelectCleint(Client selectedClient)
    {
        clientsSearch = "none";
        nameClient = selectedClient.ClientName;
        client = selectedClient;
    }

    private void ClaerBookingForm()
    {
        nameClient = string.Empty;
        bookModel.AdaltCount = 0;
        bookModel.ChildCount = 0;
        roomType = string.Empty;
        chekInDate = string.Empty; 
        chekOutDate = string.Empty;
        roomNumber = string.Empty;
    }
}

<style>
    body {
        background-color: #eeeeee
    }

    .appbar {
        margin-bottom: 20px;
    }

    #newBook {
        margin-left: 250px;
        margin-top: -1px;
    }

    #searching {
        width: 250px;
        height: 35px;
        padding-left: 24px;
    }


        #searching ~ i {
            width: 35px;
            margin-left: -272px;
        }


    .dropdownClients{
        overflow-y:scroll; 
        overflow-x:hidden; 
        margin-left: 2.6rem;
        width: 400px; 
        min-height:30px; 
        max-height:100px;
    }

    .dropdownClients a{
        cursor: pointer;
        width: 400px;
        display: block;
    }

    .typeList {
        position: relative;
        margin-top: -33px;
    }
    .typeList select {

        background: transparent;
        outline: none;
        font-size: 16px;
        border: 0;
        border-radius: 0px;
        border-bottom: 1px solid #ced4da;
        height: 35px;
        width: 400px;
        margin-left: 2.6rem;
    }

    #span {
        margin-top: -30px;
    }

    #inputBox {
        position: relative;
        margin-top: -40px;
    }

    #inputBox input {
        background-color: transparent;
        border: 0;
        border-bottom: 1px solid #ced4da;
        border-radius: 0;
        outline: none;
        color: black;
        font-size: 14px;
        margin-left: 2.6rem;
        height: 30px;
        width: 400px;
    }

    #inputBox span, .typeList span {
        position: absolute;
        left: 45px;
        padding: 4px;
        pointer-events: none;
        font-size: 0.8em;
        color: gray;
        text-transform: uppercase;
        transition: 0.5s;
    }

    .typeList select:active {
        border-color: #ced4da;
        outline: none;
    }

    .typeList select:valid ~ #span,
    .typeList select:focus ~ #span,
    #inputBox input:valid ~ #span,
    #inputBox input:focus ~ #span {
        color: grey;
        transform: translateX(-1px) translateY(-15px);
        font-size: 0.6em;
        background: none;
        letter-spacing: 0.2em;
    }



    .inputBoxClients input:valid ~ .dropdownClients,
    .inputBoxClients input:focus ~ .dropdownClients,
    .dropdownClients a:focus ~ .dropdownClients {
        display: block;
    }



    .md-form .prefix ~ input, select, textarea {
        width: calc(100% - 2rem);
        margin-left: 2.5rem;
    }

    .md-form iconify-icon {
        position: relative;
        transition: color .2s;
        font-size: 2.1rem;
    }


    .button {
        display: inline-block;
        border-radius: 4px;
        background-color: #0dcaf0;
        border: none;
        color: black;
        text-align: center;
        font-size: 16px;
        padding: 11px;
        width: 116px;
        transition: all 0.5s;
        cursor: pointer;
        margin: 5px;
    }

        .button span {
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: 0.5s;
        }

            .button span:after {
                content: '\00bb';
                position: absolute;
                opacity: 0;
                top: 0;
                right: -30px;
                transition: 0.5s;
            }

        .button:hover span {
            padding-right: 22px;
        }

            .button:hover span:after {
                opacity: 1;
                right: 0;
            }

</style>
